# =============================================================
# K-CHOPORE Configuration File
# Pipeline for ONT Direct RNA Sequencing Analysis
# =============================================================
# Experiment: anac017-1 mutant vs WT, Control vs Antimycin A (AA)
# 2x2 factorial design (unbalanced: 3+3+3+1 = 10 samples)
# Organism: Arabidopsis thaliana (TAIR10 + AtRTDv2)
# Sequencing: ONT MinION, R9.4.1 flowcell, Direct RNA
# =============================================================

# -------------------------------------------------------------
# SAMPLE SHEET
# Each sample has: genotype, treatment, data_type, and source dirs
# Sample IDs use underscores only (FLAIR requires hyphens in manifest,
# the pipeline converts automatically)
# -------------------------------------------------------------
samples:
  # --- Wild Type, Control (3 replicates) ---
  WT_C_R1:
    genotype: "WT"
    treatment: "C"
    data_type: "fastq"
    nas_dirs: ["WT_C_R1"]
    run_subdirs: ["no_sample/20220224_1639_MC-112869_FAR90122_f656439d"]
  WT_C_R2:
    genotype: "WT"
    treatment: "C"
    data_type: "fastq"
    nas_dirs: ["WT_C_R2"]
    run_subdirs: ["no_sample/20220323_1648_MC-112869_FAR91957_0263d5a0"]
  WT_C_R3:
    genotype: "WT"
    treatment: "C"
    data_type: "fastq"
    nas_dirs: ["WT_C_R3"]
    run_subdirs: ["no_sample/20220301_1656_MC-112869_FAR90189_a35665b9"]

  # --- Wild Type, Antimycin A (3 replicates) ---
  WT_AA_R1:
    genotype: "WT"
    treatment: "AA"
    data_type: "fastq"
    nas_dirs: ["WT_AA_R1"]
    run_subdirs: ["20220221_1734_MC-112869_FAR92050_00e32dc0"]
  WT_AA_R2:
    genotype: "WT"
    treatment: "AA"
    data_type: "fastq"
    nas_dirs: ["WT_AA_R2"]
    run_subdirs: ["no_sample/20220316_1902_MC-112869_FAR91120_624c5f7d"]
  WT_AA_R3:
    genotype: "WT"
    treatment: "AA"
    data_type: "fastq"
    nas_dirs: ["WT_AA_R3", "WT_AA_R3_2"]
    run_subdirs:
      - "no_sample/20220315_1614_MC-112869_FAR90098_c891954b"
      - "no_sample/20220316_1636_MC-112869_FAR90098_6e408c50"

  # --- anac017-1 mutant, Control (3 replicates) ---
  anac017_1_C_R1:
    genotype: "anac017_1"
    treatment: "C"
    data_type: "fastq"
    nas_dirs: ["anac017-1_C_R1"]
    run_subdirs: ["no_sample/20220330_1936_MC-112869_FAR92015_6ac8671e"]
  anac017_1_C_R2:
    genotype: "anac017_1"
    treatment: "C"
    data_type: "fastq"
    nas_dirs: ["anac017-1_C_R2"]
    run_subdirs: ["no_sample/20220404_1440_MC-112869_FAR91811_a135af49"]
  anac017_1_C_R3:
    genotype: "anac017_1"
    treatment: "C"
    data_type: "fastq"
    nas_dirs: ["anac017-1_C_R3"]
    run_subdirs: ["no_sample/20220405_1610_MC-112869_FAR91811_d5fba51e"]

  # --- anac017-1 mutant, Antimycin A (1 replicate) ---
  # Only R1 has pre-basecalled FASTQ data
  # R2 and R3 had FAST5-only data requiring GPU basecalling (excluded)
  anac017_1_AA_R1:
    genotype: "anac017_1"
    treatment: "AA"
    data_type: "fastq"
    nas_dirs: ["anac017-1_AA_R1"]
    run_subdirs: ["no_sample/20220328_1730_MC-112869_FAR90074_970aa1f5"]

# -------------------------------------------------------------
# INPUT FILES AND DIRECTORIES
# -------------------------------------------------------------
input_files:
  raw_data_dir: "data/raw"
  reference_genome: "data/reference/genome/TAIR10_chr_all.fas.fasta"
  reference_genome_mmi: "data/reference/genome/TAIR10_chr_all.fas.fasta.mmi"
  gtf_file: "data/reference/annotations/AtRTDv2_QUASI_19April2016.gtf"
  transcriptome_fasta: "data/reference/transcriptome/transcriptome.fa"

# -------------------------------------------------------------
# OUTPUT SETTINGS
# -------------------------------------------------------------
output:
  path: "results"
  logs: "logs"

# -------------------------------------------------------------
# TOOL CONFIGURATIONS
# -------------------------------------------------------------
tools:
  # Basecalling (not used — all 10 samples have pre-basecalled FASTQs)
  basecaller: "guppy"
  guppy_config_file: "/opt/ont-guppy-cpu/data/rna_r9.4.1_70bps_hac.cfg"

  # Alignment - minimap2 (splice-aware for direct RNA)
  minimap2_preset: "splice"
  minimap2_kmer_size: 14
  minimap2_extra_flags: "--secondary=no --MD"

  # Read filtering - NanoFilt
  nanofilt_min_quality: 7
  nanofilt_min_length: 200
  nanofilt_max_length: 0

  # Quality control
  nanoplot_format: "png"
  pycoqc_min_pass_qual: 7

  # Isoform analysis - FLAIR
  flair_support: 3
  flair_stringent: true

  # RNA modification detection - ELIGOS2
  # Note: ELIGOS2 has a known CMH test failure (rpy2/R issue in Docker).
  # The pipeline creates placeholder outputs when ELIGOS2 fails.
  eligos2_pval: 0.05
  eligos2_oddR: 2.5
  eligos2_esb: 0.1

  # RNA modification detection - m6Anet
  m6anet_num_iterations: 1000
  m6anet_num_processors: 4

  # Differential expression - DESeq2 (2x2 factorial, additive model)
  # Additive model used because anac017_1 x AA group has only 1 replicate
  deseq2_padj_threshold: 0.05
  deseq2_lfc_threshold: 1.0

# -------------------------------------------------------------
# ANNOTATION BUNDLE (v3.0 modules)
# Download with: bash scripts/download_annotations.sh
# -------------------------------------------------------------
annotations:
  araport11_gff: "data/reference/annotations/Araport11_GFF3_genes_transposons.gff"
  cantatadb_bed: "data/reference/annotations/CANTATAdb_v3_arabidopsis.bed"
  mirbase_gff: "data/reference/annotations/miRBase_v22_ath.gff3"
  mirbase_mature_fa: "data/reference/annotations/miRBase_v22_ath_mature.fa"
  pmiren_fa: "data/reference/annotations/PmiREN_ath_miRNA.fa"
  te_annotation: "data/reference/annotations/TAIR10_TE_annotation.bed"

# -------------------------------------------------------------
# SMALL RNA SAMPLES (Module 2 — Illumina sRNA-seq)
# Enable run_smallrna and configure these when Illumina data is ready
# Same 2x2 factorial design as DRS samples
# -------------------------------------------------------------
srna_samples: {}
  # Example:
  # WT_C_sRNA_R1:
  #   genotype: "WT"
  #   treatment: "C"
  #   fastq: "data/raw/srna/WT_C_sRNA_R1.fastq.gz"

# -------------------------------------------------------------
# DEGRADOME / PARE SAMPLES (Module 3)
# Used for experimental validation of miRNA-target interactions
# -------------------------------------------------------------
degradome_samples: {}
  # Example:
  # WT_C_PARE:
  #   condition: "WT_C"
  #   fastq: "data/raw/degradome/WT_C_PARE.fastq.gz"

# -------------------------------------------------------------
# EPITRANSCRIPTOMIC COMPARISONS (Module 4)
# Define pairwise comparisons for differential modification
# -------------------------------------------------------------
epitx_comparisons:
  - name: "treatment_WT"
    control: ["WT_C_R1", "WT_C_R2", "WT_C_R3"]
    treated: ["WT_AA_R1", "WT_AA_R2", "WT_AA_R3"]
  - name: "genotype_control"
    control: ["WT_C_R1", "WT_C_R2", "WT_C_R3"]
    treated: ["anac017_1_C_R1", "anac017_1_C_R2", "anac017_1_C_R3"]

# -------------------------------------------------------------
# ANALYSIS PARAMETERS
# -------------------------------------------------------------
params:
  threads: 40
  latency_wait: 60

  # --- v2.0 module toggles ---
  # m6Anet requires FAST5 data on local disk.
  run_m6anet: false

  # --- v3.0 ncRNA module toggles ---
  run_lncrna: true           # Module 1: lncRNA discovery from DRS data
  run_smallrna: false         # Module 2: Illumina sRNA-seq analysis (enable when data ready)
  run_mirna_targets: false    # Module 3: miRNA target prediction + degradome (enable after Module 2)
  run_epitx_enhanced: true    # Module 4: Enhanced epitranscriptomics (Nanocompore + consensus)
  run_integration: false      # Module 5: Multi-omics data integration (enable after all modules)

  # --- Module 1: lncRNA parameters ---
  lncrna_min_length: 200       # Minimum transcript length (nt) for lncRNA candidates
  lncrna_min_exons: 1          # 1=allow mono-exonic, 2=multi-exon only
  lncrna_min_support: 3        # Minimum read support across samples
  lncrna_max_orf_aa: 100       # TransDecoder ORF cutoff (aa)
  lncrna_consensus_min: 2      # Min tools agreeing "non-coding" (out of FEELnc, CPC2, CPAT)
  feelnc_mode: "shuffle"       # FEELnc training mode: "shuffle" or "intergenic"
  cpat_threshold: 0.39         # Arabidopsis-specific CPAT coding probability cutoff

  # --- Module 2: Small RNA parameters ---
  srna_adapter: "auto"         # Adapter sequence or "auto" for auto-detection
  srna_min_length: 18          # Minimum sRNA read length (nt)
  srna_max_length: 30          # Maximum sRNA read length (nt)
  shortstack_mincov: 5         # ShortStack minimum coverage
  shortstack_dicermin: 20      # ShortStack minimum Dicer size
  shortstack_dicermax: 24      # ShortStack maximum Dicer size
  mirdeep_score_cutoff: 1      # miRDeep-P2 minimum score

  # --- Module 3: Target prediction parameters ---
  targetfinder_cutoff: 4.0     # TargetFinder score cutoff
  psrnatarget_expectation: 3.0 # psRNATarget expectation value
  degradome_category_max: 2    # Maximum T-plot category (0-4, lower = better)

  # --- Module 4: Epitranscriptomics parameters ---
  nanocompore_min_coverage: 30 # Minimum per-site read coverage for Nanocompore
  nanocompore_pval: 0.05       # Nanocompore p-value threshold
  epitx_consensus_min_tools: 2 # Minimum tools agreeing on modification site
  epitx_run_remora: false      # Enable Remora/Dorado modification calling (requires FAST5+GPU)

  # --- Module 5: Integration parameters ---
  wgcna_soft_power: "auto"     # WGCNA soft-thresholding power (auto or integer)
  wgcna_min_module_size: 30    # WGCNA minimum module size
  cis_window_kb: 10            # lncRNA–gene cis-regulation window (kb)
  population_vcf: ""           # Path to 1001 Genomes VCF (optional)
